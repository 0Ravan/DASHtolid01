
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد مدیریت تولید پیشرفته</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDip8Z7tEGQh45-DUfuYpZQobK3AAGBW4o",
            authDomain: "my-production-dashboard.firebaseapp.com",
            projectId: "my-production-dashboard",
            storageBucket: "my-production-dashboard.firebasestorage.app",
            messagingSenderId: "626829274209",
            appId: "1:626829274209:web:cd6b1ccc3b63df29b9ce20"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const dbDocRef = doc(db, "dashboardData", "mainState");

        window.firebaseServices = { db, auth, dbDocRef, setDoc, onSnapshot, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut };
    </script>

    <style>
        :root {
            --primary-color: #0d6efd; --primary-hover: #0b5ed7; --secondary-color: #6c757d;
            --success-color: #198754; --warning-color: #ffc107; --danger-color: #dc3545;
            --commission-color: #fd7e14; --tracking-color: #6f42c1;
            --inventory-color: #0dcaf0;
            --materials-color: #d63384;
            --light-color: #f8f9fa; --dark-color: #212529; --border-color: #dee2e6;
            --font-main: 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        body { font-family: var(--font-main); background-color: #f0f2f5; margin: 0; padding: 20px; color: var(--dark-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { max-width: 1600px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); width: 100%;}
        h1, h2, h3 { color: var(--dark-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-top: 20px; }
        h1 { font-size: 26px; } h2 { font-size: 22px; } h3 { font-size: 18px; margin-top: 30px; border-color: var(--secondary-color); }
        button { font-family: var(--font-main); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; margin: 5px; transition: all 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-primary { background-color: var(--primary-color); } .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-danger { background-color: var(--danger-color); } .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: var(--success-color); }
        .btn-warning { background-color: var(--warning-color); color: #000; }
        .btn-commission { background-color: var(--commission-color); }
        .btn-tracking { background-color: var(--tracking-color); }
        .btn-inventory { background-color: var(--inventory-color); color: #000; }
        .btn-materials { background-color: var(--materials-color); }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { padding: 12px; text-align: right; border: 1px solid var(--border-color); vertical-align: middle; }
        th { background-color: var(--dark-color); color: white; position: sticky; top: 0; z-index: 1;}
        tr:nth-child(even) { background-color: var(--light-color); }
        .page-view { margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .file-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; }
        .filters, .bulk-update { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; padding: 15px; background: var(--light-color); border-radius: 8px; align-items: center; }
        .filters label { font-size: 15px; display: flex; align-items: center; gap: 8px; }
        .filters select, .filters input, .bulk-update select, .bulk-update button, #manualForm input, #manualForm select, textarea { padding: 10px; font-size: 15px; border: 1px solid var(--border-color); border-radius: 5px; font-family: var(--font-main); }
        .status-ready { background-color: #e9ecef; }
        .status-inprogress { background-color: #fff3cd; }
        .status-printing { background-color: #cff4fc; }
        .status-done { background-color: #d1e7dd; }
        .status-cancelled { background-color: #f8d7da; text-decoration: line-through; color: #6c757d; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: var(--light-color); padding: 20px; border-radius: 8px; text-align: center; border-left: 5px solid; }
        .card h4 { margin: 0 0 10px; font-size: 16px; color: var(--secondary-color); }
        .card .count { font-size: 32px; font-weight: bold; }
        .card-total { border-color: var(--primary-color); }
        .card-ready { border-color: var(--secondary-color); }
        .card-inprogress { border-color: var(--warning-color); }
        .card-done { border-color: var(--success-color); }
        .nav-buttons { margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;}
        #auth-container { max-width: 400px; margin: auto; }
        #app-container { display: none; }
        .auth-form { display: flex; flex-direction: column; gap: 15px; }
        .auth-form input { padding: 12px; font-size: 16px; border: 1px solid var(--border-color); border-radius: 6px;}
        .auth-toggle { text-align: center; margin-top: 15px; color: var(--primary-color); cursor: pointer; }
        #user-info { display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--secondary-color); }
        #logoutBtn { font-size: 12px; padding: 5px 10px; background-color: var(--danger-color); }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            width: 90%; max-width: 600px; transform: scale(0.9); transition: transform 0.3s;
            display: flex; flex-direction: column; max-height: 90vh;
        }
        #editQuantityModal .modal-content {
             max-width: 900px; width: 90vw;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); }
        .modal-content h3, .modal-content p, #inventoryWarningContainer, .modal-buttons, .modal-form-group { flex-shrink: 0; }
        .modal-content h3 { margin-top: 0; border-color: var(--danger-color); }
        .modal-content p { margin: 15px 0; line-height: 1.6; }
        .modal-buttons { text-align: left; margin-top: 25px; }
        .btn-secondary { background-color: var(--secondary-color); }
        .modal-form-group { margin: 15px 0; }
        .modal-form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .modal-form-group input, .modal-form-group select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); box-sizing: border-box; font-family: var(--font-main); font-size: 15px; }
        #manualForm { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        #editQuantityList { flex-grow: 1; overflow-y: auto; margin-top: 20px; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; background-color: #fff; }
        
        /* Tracking & Report View Styles */
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; color: white; display: inline-block; }
        .status-badge-completed { background-color: var(--success-color); }
        .status-badge-inprogress { background-color: var(--warning-color); color: #000; }
        .details-row { display: none; }
        .details-row.visible { display: table-row; }
        .details-cell { padding: 0 !important; }
        .details-content { background-color: #f8f9fa; padding: 20px; border: 2px solid var(--tracking-color); display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .details-content h4 { grid-column: 1 / -1; margin-top:0; color: var(--tracking-color); border-bottom: 1px solid var(--tracking-color); padding-bottom: 10px; }
        .stage-checklist { list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stage-checklist li { display: flex; align-items: center; font-size: 16px; }
        .stage-checklist input[type="checkbox"] { width: 20px; height: 20px; margin-left: 12px; cursor: pointer; }
        #batchTrackingTableContainer table td button { padding: 5px 10px; font-size: 13px; }
        .has-batch-code { background-color: #f3e5f5 !important; }
        
        #inventoryWarningContainer { background: #fff3cd; border: 1px solid var(--warning-color); border-radius: 8px; padding: 15px; margin-bottom: 20px; max-height: 150px; overflow-y: auto; }
        #inventoryWarningContainer p { margin: 5px 0; font-weight: 500; }
        .low-inventory { color: var(--danger-color); font-weight: bold; }
        .upload-area { border: 2px dashed; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px; background-color: #f8f9fa; }
        #dataManagement { border-top: 2px solid var(--primary-color); margin-top: 20px; padding-top: 15px; display: flex; gap: 10px; justify-content: flex-end; align-items: center; }

    </style>
</head>
<body>
    
    <div id="auth-container">
        <div class="container" style="max-width: 450px;">
            <h2 id="authTitle">ورود به داشبورد</h2>
            <div id="login-form" class="auth-form">
                <input type="email" id="loginEmail" placeholder="ایمیل" required>
                <input type="password" id="loginPassword" placeholder="رمز عبور" required>
                <button id="loginBtn" class="btn-primary">ورود</button>
            </div>
            <div id="signup-form" class="auth-form hidden">
                 <input type="email" id="signupEmail" placeholder="ایمیل" required>
                <input type="password" id="signupPassword" placeholder="رمز عبور" required>
                <button id="signupBtn" class="btn-primary">ثبت نام</button>
            </div>
             <p id="auth-toggle" class="auth-toggle">حساب کاربری ندارید؟ ثبت نام کنید</p>
        </div>
    </div>
    
    <div id="app-container" class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>داشبورد مدیریت تولید</h1>
             <div id="user-info">
                <span id="userEmail"></span>
                <button id="logoutBtn">خروج</button>
            </div>
        </div>
        <div id="dataManagement">
             <input type="file" id="importFile" class="hidden" accept=".json">
             <button id="exportDataBtn" class="btn-secondary">تهیه نسخه پشتیبان (Backup)</button>
             <button id="importDataBtn" class="btn-secondary">بازیابی اطلاعات (Restore)</button>
        </div>
        
        <div class="nav-buttons">
            <button id="showDashboardBtn" class="btn-primary">مدیریت فایل‌ها</button>
            <button id="showManualProductionBtn" class="btn-commission">تولید کارمزدی</button>
            <button id="showReportBtn" class="btn-primary" style="background-color: var(--success-color);">گزارش جامع</button>
            <button id="showPrintingBtn" class="btn-primary" style="background-color: var(--inventory-color); color: #000;">در دست چاپ</button>
            <button id="showTrackingBtn" class="btn-tracking">رهگیری تولید</button>
            <button id="showInventoryBtn" class="btn-inventory">موجودی‌ها</button>
            <button id="showMaterialsBtn" class="btn-materials">استاندارد مواد</button>
        </div>

        <div id="dashboardView" class="page-view">
            <h2>بارگذاری و انتخاب فایل</h2>
            <div class="upload-area" style="border-color: var(--primary-color);">
                <input type="file" id="excelFile" class="hidden" accept=".xls,.xlsx,.csv" multiple>
                <label for="excelFile" class="btn-primary">بارگذاری فایل (های) جدید</label>
            </div>
            <div id="fileList" style="margin-top: 20px;"></div>
        </div>

        <div id="materialsView" class="page-view hidden">
            <h2>مدیریت مواد اولیه و استاندارد مصرف</h2>
             <div class="upload-area" style="border-color: var(--materials-color); margin-bottom: 30px;">
                <input type="file" id="materialsExcelFile" class="hidden" accept=".xls,.xlsx,.csv">
                <label for="materialsExcelFile" class="btn-materials">بارگذاری/افزودن اکسل مواد اولیه</label>
                 <p style="color: #6c757d; font-size: 14px; margin-top: 10px;">فایل باید شامل ستون‌های 'نام مواد اولیه'، 'رنگ'، 'مقدار' و 'واحد سنجش' باشد. مقادیر به موجودی فعلی اضافه می‌شوند.</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                <div>
                    <h3>تعریف/افزودن دستی مواد اولیه</h3>
                    <div class="filters">
                        <input type="text" id="materialName" placeholder="نام ماده اولیه" style="flex-grow: 2;">
                        <input type="text" id="materialColor" placeholder="رنگ ماده اولیه">
                        <input type="number" id="materialStock" placeholder="مقدار برای افزودن" min="0">
                         <input type="text" id="materialUnit" placeholder="واحد (متر، عدد...)" >
                        <button id="addMaterialBtn" class="btn-primary">افزودن</button>
                    </div>
                    <div id="materialsTableContainer" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div>
                    <h3>تعریف استاندارد مصرف (به ازای هر واحد محصول)</h3>
                     <div class="filters">
                        <select id="bomGroupSelect" style="flex-grow: 1;"></select>
                        <select id="bomMaterialSelect" style="flex-grow: 1;"></select>
                        <select id="bomMaterialColorSelect" style="flex-grow: 1;"></select>
                        <input type="number" id="bomConsumptionInput" placeholder="میزان مصرف" min="0" step="0.1">
                        <button id="addBomBtn" class="btn-materials">ثبت استاندارد</button>
                    </div>
                    <div id="bomTableContainer" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>


        <div id="inventoryView" class="page-view hidden">
            <h2>مدیریت موجودی محصولات آماده</h2>
            <div class="upload-area" style="border-color: var(--inventory-color);">
                 <input type="file" id="inventoryExcelFile" class="hidden" accept=".xls,.xlsx,.csv">
                <label for="inventoryExcelFile" class="btn-inventory">بارگذاری/افزودن فایل موجودی</label>
                <p style="color: #6c757d; font-size: 14px; margin-top: 10px;">فایل اکسل باید شامل ستون‌های 'نام آیتم' و 'تعداد (- استرداد)' باشد. مقادیر به موجودی فعلی اضافه/کسر می‌شوند.</p>
            </div>
            <div id="inventoryTableContainer" style="margin-top: 20px;"></div>
        </div>

        <div id="manualProductionView" class="page-view hidden">
            <h2>ایجاد دستور تولید دستی (کارمزدی)</h2>
            <form id="manualForm" class="filters">
                <input type="text" id="manualProductName" placeholder="نام محصول">
                <input type="text" id="manualSku" placeholder="کد طرح">
                <input type="text" id="manualColor" placeholder="رنگ">
                <select id="manualSize">
                    <option value="">-- سایز --</option>
                    <option>S</option><option>M</option><option>L</option><option>XL</option>
                    <option>2XL</option><option>3XL</option><option>XS</option><option>تک سایز</option>
                </select>
                <input type="number" id="manualQuantity" placeholder="تعداد" min="1">
                 <select id="manualGroup">
                    <option value="">-- گروه محصول --</option>
                    <option>هودی</option><option>تیشرت</option><option>بامبر</option>
                    <option>دورس</option><option>شلوار</option><option>سویشرت</option><option>سایر</option>
                </select>
                <button type="button" id="addItemToManualListBtn" class="btn-primary" style="grid-column: 1 / -1;">افزودن آیتم</button>
            </form>
            <div id="manualItemsContainer" style="margin-top: 30px;">
                 <h3>لیست آیتم‌های دستور تولید فعلی</h3>
                 <div id="manualItemsTableContainer" style="max-height: 400px; overflow-y: auto;"><p>هنوز آیتمی اضافه نشده است.</p></div>
            </div>
            <div class="bulk-update" style="margin-top: 20px;">
                <button id="saveManualOrderBtn" class="btn-success">ذخیره و ارسال به گزارش جامع</button>
                <button id="clearManualOrderBtn" class="btn-danger">پاک کردن لیست فعلی</button>
            </div>
        </div>

        <div id="processingView" class="page-view hidden">
            <button id="backToDashboard" class="btn-primary" style="background-color: var(--secondary-color);">بازگشت به لیست فایل‌ها</button>
            <h2 id="processingFileName"></h2>
            <h3>فیلتر و صدور دستور تولید</h3>
            <div class="filters">
                <label>گروه محصول: <select id="groupFilter"><option value="">همه</option></select></label>
                <label>فیلتر رنگ: <select id="colorFilter"><option value="">همه</option></select></label>
                <label>فیلتر سایز: <select id="sizeFilter"><option value="">همه</option></select></label>
                <label>وضعیت: <select id="processingStatusFilter">
                    <option value="">همه</option>
                    <option>آماده تولید</option>
                    <option>درحال انجام</option>
                    <option>در دست چاپ</option>
                    <option>انجام شده</option>
                    <option>ابطال</option>
                </select></label>
                <button id="clearProcessingFiltersBtn" class="btn-secondary" style="margin-right: auto;">پاک کردن فیلترها</button>
            </div>
            <div class="bulk-update">
                <span>عملیات گروهی (برای موارد انتخابی):</span>
                <button id="createProductionOrderBtn" class="btn-success">صدور دستور تولید</button>
            </div>
            <div id="summaryCards" class="summary-cards"></div>
            <div id="tasksTableContainer" style="max-height: 600px; overflow-y: auto;"></div>
        </div>

        <div id="reportView" class="page-view hidden">
            <h2>بایگانی و رهگیری دستورات تولید</h2>
             <div class="filters">
                <label>فیلتر فایل: <select id="reportFileFilter"><option value="">همه فایل‌ها</option></select></label>
                <label>فیلتر وضعیت: <select id="reportStatusFilter"><option value="">همه وضعیت‌ها</option><option value="درحال انجام">درحال انجام</option><option value="در دست چاپ">در دست چاپ</option><option value="انجام شده">انجام شده</option><option value="ابطال">ابطال</option></select></label>
                <label>گروه محصول: <select id="reportGroupFilter"><option value="">همه گروه‌ها</option></select></label>
                <label>کد بچ: <input type="text" id="reportBatchSearch" placeholder="جستجوی کد بچ..."></label>
                <label>وضعیت کدبچ: 
                    <select id="reportBatchFilter">
                        <option value="">همه</option>
                        <option value="assigned">کد بچ دار</option>
                        <option value="unassigned">بدون کد بچ</option>
                    </select>
                </label>
                <button id="clearReportFiltersBtn" class="btn-secondary" style="margin-right: auto;">پاک کردن فیلترها</button>
            </div>
            <div class="bulk-update">
                <span>عملیات گروهی (برای موارد انتخابی):</span>
                <label>تغییر به: <select id="reportToStatus"><option value="آماده تولید">بازگشت به آماده تولید</option><option value="درحال انجام">درحال انجام</option><option value="در دست چاپ">در دست چاپ</option><option value="انجام شده">انجام شده</option><option value="ابطال">ابطال</option></select></label>
                <button id="reportBulkUpdateBtn" class="btn-warning">اعمال تغییر</button>
                <button id="sendToPrintingBtn" class="btn-primary" style="background-color: var(--inventory-color); color: #000;">ارسال برای چاپ</button>
                <button id="assignBatchCodeBtn" class="btn-primary">اختصاص کد بچ</button>
                <button id="exportReportBtn" class="btn-success">خروجی اکسل</button>
            </div>
            <div id="reportSummaryCards" class="summary-cards"></div>
            <div id="reportTableContainer" style="max-height: 700px; overflow-y: auto;"></div>
        </div>
        
        <div id="printingView" class="page-view hidden">
            <h2>مدیریت اقلام در دست چاپ</h2>
             <div class="filters">
                <label>فیلتر فایل: <select id="printingFileFilter"><option value="">همه فایل‌ها</option></select></label>
                <label>گروه محصول: <select id="printingGroupFilter"><option value="">همه گروه‌ها</option></select></label>
                <label>فیلتر رنگ: <select id="printingColorFilter"><option value="">همه رنگ‌ها</option></select></label>
                <label>فیلتر سایز: <select id="printingSizeFilter"><option value="">همه سایزها</option></select></label>
                <button id="clearPrintingFiltersBtn" class="btn-secondary" style="margin-right: auto;">پاک کردن فیلترها</button>
            </div>
            <div class="bulk-update">
                <span>عملیات گروهی (برای موارد انتخابی):</span>
                <button id="printingBulkUpdateBtn" class="btn-warning">تغییر وضعیت به چاپ شده</button>
                <button id="exportPrintingBtn" class="btn-success">خروجی اکسل</button>
                <button id="printPrintingBtn" class="btn-primary">چاپ لیست</button>
            </div>
            <div id="printingSummaryCards" class="summary-cards"></div>
            <div id="printingTableContainer" style="max-height: 700px; overflow-y: auto;"></div>
        </div>

        <div id="trackingView" class="page-view hidden">
            <h2>رهگیری مراحل تولید</h2>
            <div class="filters">
                <input type="text" id="trackingSearchInput" placeholder="جستجو بر اساس کد بچ...">
                <label>تاریخ ایجاد: <input type="date" id="trackingDateFilter"></label>
                <label>گروه محصول: <select id="trackingGroupFilter"><option value="">همه</option></select></label>
                <label>وضعیت: <select id="trackingStatusFilter"><option value="">همه</option><option value="completed">تکمیل شده</option><option value="inprogress">درحال انجام</option></select></label>
                <button id="clearTrackingFiltersBtn" class="btn-secondary">پاک کردن فیلترها</button>
                <button id="exportTrackingBtn" class="btn-success" style="margin-right: auto;">خروجی اکسل</button>
            </div>
            <div id="batchTrackingTableContainer" style="max-height: 700px; overflow-y: auto;">
                <!-- Tracking table will be rendered here -->
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="btn-danger">تایید</button>
                <button id="modalCancelBtn" class="btn-secondary">لغو</button>
            </div>
        </div>
    </div>

    <div id="assignBatchModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="assignBatchModalTitle">اختصاص کد بچ و زمان تحویل</h3>
            <p>یک کد بچ برای آیتم‌های انتخابی وارد کرده و تاریخ تحویل را مشخص کنید.</p>
            <div class="modal-form-group">
                <label for="batchCodeInput">کد بچ/سری:</label>
                <input type="text" id="batchCodeInput" placeholder="کد به صورت خودکار تولید می‌شود">
            </div>
             <div class="modal-form-group">
                <label>تاریخ تحویل:</label>
                <div style="display: flex; gap: 10px;">
                    <select id="batchDeliveryDay" style="width: 100%;"><option value="">روز</option></select>
                    <select id="batchDeliveryMonth" style="width: 100%;"><option value="">ماه</option></select>
                    <select id="batchDeliveryYear" style="width: 100%;"><option value="">سال</option></select>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="batchConfirmBtn" class="btn-success">تایید و اختصاص کد</button>
                <button id="batchCancelBtn" class="btn-secondary">لغو</button>
            </div>
        </div>
    </div>

    <div id="editQuantityModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>تغییر تعداد برای دستور تولید</h3>
            <div id="inventoryWarningContainer"></div>
            <p>تعداد مورد نظر برای ارسال به خط تولید را مشخص کنید. مابقی در لیست "آماده تولید" باقی خواهد ماند.</p>
            <div id="editQuantityList">
                <!-- Dynamic content will be injected here -->
            </div>
            <div class="modal-buttons">
                <button id="quantityConfirmBtn" class="btn-success">تایید و ارسال</button>
                <button id="quantityCancelBtn" class="btn-secondary">لغو</button>
            </div>
        </div>
    </div>


<script type="module">
    document.addEventListener('DOMContentLoaded', () => {

    const { auth, dbDocRef, setDoc, onSnapshot, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } = window.firebaseServices;
    
    // --- State & Elements ---
    const elements = {
        authContainer: document.getElementById('auth-container'),
        appContainer: document.getElementById('app-container'),
        loginForm: document.getElementById('login-form'),
        signupForm: document.getElementById('signup-form'),
        authToggle: document.getElementById('auth-toggle'),
        authTitle: document.getElementById('authTitle'),
        loginBtn: document.getElementById('loginBtn'),
        signupBtn: document.getElementById('signupBtn'),
        logoutBtn: document.getElementById('logoutBtn'),
        userEmail: document.getElementById('userEmail'),
        
        dashboardView: document.getElementById('dashboardView'), 
        processingView: document.getElementById('processingView'),
        manualProductionView: document.getElementById('manualProductionView'),
        reportView: document.getElementById('reportView'),
        printingView: document.getElementById('printingView'),
        trackingView: document.getElementById('trackingView'),
        inventoryView: document.getElementById('inventoryView'),
        materialsView: document.getElementById('materialsView'),
        excelFile: document.getElementById('excelFile'), fileList: document.getElementById('fileList'),
        backToDashboard: document.getElementById('backToDashboard'), processingFileName: document.getElementById('processingFileName'),
        groupFilter: document.getElementById('groupFilter'), colorFilter: document.getElementById('colorFilter'), sizeFilter: document.getElementById('sizeFilter'),
        processingStatusFilter: document.getElementById('processingStatusFilter'),
        tasksTableContainer: document.getElementById('tasksTableContainer'), summaryCards: document.getElementById('summaryCards'),
        createProductionOrderBtn: document.getElementById('createProductionOrderBtn'),
        showDashboardBtn: document.getElementById('showDashboardBtn'), 
        showReportBtn: document.getElementById('showReportBtn'),
        showManualProductionBtn: document.getElementById('showManualProductionBtn'),
        showPrintingBtn: document.getElementById('showPrintingBtn'),
        showTrackingBtn: document.getElementById('showTrackingBtn'),
        showInventoryBtn: document.getElementById('showInventoryBtn'),
        showMaterialsBtn: document.getElementById('showMaterialsBtn'),
        reportFileFilter: document.getElementById('reportFileFilter'), reportStatusFilter: document.getElementById('reportStatusFilter'),
        reportBulkUpdateBtn: document.getElementById('reportBulkUpdateBtn'), reportToStatus: document.getElementById('reportToStatus'),
        reportSummaryCards: document.getElementById('reportSummaryCards'), reportTableContainer: document.getElementById('reportTableContainer'),
        reportGroupFilter: document.getElementById('reportGroupFilter'),
        reportColorFilter: document.getElementById('reportColorFilter'),
        reportSizeFilter: document.getElementById('reportSizeFilter'),
        reportBatchSearch: document.getElementById('reportBatchSearch'),
        reportBatchFilter: document.getElementById('reportBatchFilter'),
        assignBatchCodeBtn: document.getElementById('assignBatchCodeBtn'),
        sendToPrintingBtn: document.getElementById('sendToPrintingBtn'),
        exportReportBtn: document.getElementById('exportReportBtn'),
        // Printing View Elements
        printingFileFilter: document.getElementById('printingFileFilter'),
        printingGroupFilter: document.getElementById('printingGroupFilter'),
        printingColorFilter: document.getElementById('printingColorFilter'),
        printingSizeFilter: document.getElementById('printingSizeFilter'),
        clearPrintingFiltersBtn: document.getElementById('clearPrintingFiltersBtn'),
        printingBulkUpdateBtn: document.getElementById('printingBulkUpdateBtn'),
        exportPrintingBtn: document.getElementById('exportPrintingBtn'),
        printPrintingBtn: document.getElementById('printPrintingBtn'),
        printingSummaryCards: document.getElementById('printingSummaryCards'),
        printingTableContainer: document.getElementById('printingTableContainer'),
        // Inventory Elements
        inventoryExcelFile: document.getElementById('inventoryExcelFile'),
        inventoryTableContainer: document.getElementById('inventoryTableContainer'),
        // Materials Elements
        materialsExcelFile: document.getElementById('materialsExcelFile'),
        materialName: document.getElementById('materialName'),
        materialColor: document.getElementById('materialColor'),
        materialStock: document.getElementById('materialStock'),
        materialUnit: document.getElementById('materialUnit'),
        addMaterialBtn: document.getElementById('addMaterialBtn'),
        materialsTableContainer: document.getElementById('materialsTableContainer'),
        bomGroupSelect: document.getElementById('bomGroupSelect'),
        bomMaterialSelect: document.getElementById('bomMaterialSelect'),
        bomMaterialColorSelect: document.getElementById('bomMaterialColorSelect'),
        bomConsumptionInput: document.getElementById('bomConsumptionInput'),
        addBomBtn: document.getElementById('addBomBtn'),
        bomTableContainer: document.getElementById('bomTableContainer'),
        // Manual Production Elements
        manualForm: document.getElementById('manualForm'),
        addItemToManualListBtn: document.getElementById('addItemToManualListBtn'),
        manualItemsTableContainer: document.getElementById('manualItemsTableContainer'),
        saveManualOrderBtn: document.getElementById('saveManualOrderBtn'),
        clearManualOrderBtn: document.getElementById('clearManualOrderBtn'),
        // Tracking View
        batchTrackingTableContainer: document.getElementById('batchTrackingTableContainer'),
        trackingSearchInput: document.getElementById('trackingSearchInput'),
        trackingDateFilter: document.getElementById('trackingDateFilter'),
        trackingGroupFilter: document.getElementById('trackingGroupFilter'),
        trackingStatusFilter: document.getElementById('trackingStatusFilter'),
        exportTrackingBtn: document.getElementById('exportTrackingBtn'),
        // Modals & Data Management
        importFile: document.getElementById('importFile'),
        importDataBtn: document.getElementById('importDataBtn'),
        exportDataBtn: document.getElementById('exportDataBtn'),
        confirmationModal: document.getElementById('confirmationModal'),
        modalTitle: document.getElementById('modalTitle'),
        modalMessage: document.getElementById('modalMessage'),
        modalConfirmBtn: document.getElementById('modalConfirmBtn'),
        modalCancelBtn: document.getElementById('modalCancelBtn'),
        assignBatchModal: document.getElementById('assignBatchModal'),
        assignBatchModalTitle: document.getElementById('assignBatchModalTitle'),
        batchCodeInput: document.getElementById('batchCodeInput'),
        batchDeliveryYear: document.getElementById('batchDeliveryYear'),
        batchDeliveryMonth: document.getElementById('batchDeliveryMonth'),
        batchDeliveryDay: document.getElementById('batchDeliveryDay'),
        batchConfirmBtn: document.getElementById('batchConfirmBtn'),
        batchCancelBtn: document.getElementById('batchCancelBtn'),
        editQuantityModal: document.getElementById('editQuantityModal'),
        editQuantityList: document.getElementById('editQuantityList'),
        inventoryWarningContainer: document.getElementById('inventoryWarningContainer'),
        quantityConfirmBtn: document.getElementById('quantityConfirmBtn'),
        quantityCancelBtn: document.getElementById('quantityCancelBtn'),
        // Clear Filter Buttons
        clearProcessingFiltersBtn: document.getElementById('clearProcessingFiltersBtn'),
        clearReportFiltersBtn: document.getElementById('clearReportFiltersBtn'),
        clearTrackingFiltersBtn: document.getElementById('clearTrackingFiltersBtn'),
    };
    
    const defaultState = {
        files: {},
        productionLog: [],
        productionBatches: {},
        inventory: {}, // New structure: { 'GroupName': { 'Color': { 'Size': quantity } } }
        materials: {}, // { 'MaterialName': { 'Color': { stock, unit } } }
        bom: {}, // { 'GroupName': { 'MaterialName': { 'Color': consumption } } }
        fileCounter: 0,
        batchCounterA: 1,
        batchMonthA: '',
        batchCounterK: 1,
        batchMonthK: '',
        activeFileId: null,
    };

    let appState = { ...defaultState };
    let isInitialDataLoad = true; 

    const STATUSES = { 
        READY: 'آماده تولید', 
        IN_PROGRESS: 'درحال انجام', 
        PRINTING: 'در دست چاپ',
        DONE: 'انجام شده',
        CANCELLED: 'ابطال'
    };
    const PRODUCTION_STAGES = {
        preparation: 'آماده سازی', patternMaking: 'الگو سازی', cutting: 'برش', sewing: 'دوخت',
        ironing: 'اتوکاری', packaging: 'بسته بندی', outsourcing: 'برون سپاری', printing: 'چاپ و پرس'
    };
    let manualOrderItems = [];
    let currentFilteredBatches = [];


    // --- Core Functions ---
    async function saveState() {
        if (window.firebaseServices && window.firebaseServices.setDoc) {
            try {
                await window.firebaseServices.setDoc(window.firebaseServices.dbDocRef, appState);
            } catch (error) {
                console.error("Error saving state to Firebase:", error);
                showToast('خطا در ذخیره اطلاعات در سرور.', 'error');
            }
        }
    }
    
    function initializeAppWithData(data) {
        appState = { ...defaultState, ...data };
        
        if (isInitialDataLoad) {
            renderDashboard();
            showView('dashboardView');
            isInitialDataLoad = false;
        } else {
            const visibleView = document.querySelector('.page-view:not(.hidden)');
            if (!visibleView) {
                renderDashboard();
                showView('dashboardView');
                return;
            }

            switch (visibleView.id) {
                case 'dashboardView':
                    renderDashboard();
                    break;
                case 'processingView':
                    if (appState.activeFileId && appState.files[appState.activeFileId]) {
                        renderProcessingView();
                    } else {
                        showView('dashboardView');
                        renderDashboard();
                    }
                    break;
                case 'reportView':
                    renderReportView();
                    break;
                case 'printingView':
                    renderPrintingView();
                    break;
                case 'trackingView':
                    renderTrackingView();
                    break;
                case 'inventoryView':
                    renderInventoryView();
                    break;
                case 'materialsView':
                    renderMaterialsView();
                    break;
            }
        }
    }
    
    // --- Auth Logic ---
    onAuthStateChanged(auth, user => {
        if (user) {
            isInitialDataLoad = true;
            elements.appContainer.style.display = 'block';
            elements.authContainer.style.display = 'none';
            elements.userEmail.textContent = user.email;
            onSnapshot(dbDocRef, (doc) => {
                if (doc.exists()) {
                    initializeAppWithData(doc.data());
                } else {
                    initializeAppWithData(defaultState);
                    saveState();
                }
            });
        } else {
            elements.appContainer.style.display = 'none';
            elements.authContainer.style.display = 'block';
        }
    });

    elements.authToggle.addEventListener('click', () => {
        const isLogin = elements.loginForm.classList.contains('hidden');
        elements.loginForm.classList.toggle('hidden');
        elements.signupForm.classList.toggle('hidden');
        elements.authTitle.textContent = isLogin ? 'ورود به داشبورد' : 'ایجاد حساب کاربری';
        elements.authToggle.textContent = isLogin ? 'حساب کاربری ندارید؟ ثبت نام کنید' : 'حساب کاربری دارید؟ وارد شوید';
    });

    elements.signupBtn.addEventListener('click', async () => {
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showToast('ثبت نام با موفقیت انجام شد.', 'success');
        } catch (error) {
            showToast(`خطا در ثبت نام: ${error.message}`, 'error');
        }
    });

    elements.loginBtn.addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            showToast(`خطا در ورود: ${error.message}`, 'error');
        }
    });

    elements.logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
        } catch (error) {
            showToast(`خطا در خروج: ${error.message}`, 'error');
        }
    });


    // --- Modal Logic ---
    let onConfirmCallback = null;
    const showConfirmationModal = (title, message, onConfirm) => {
        elements.modalTitle.textContent = title;
        elements.modalMessage.innerHTML = message;
        onConfirmCallback = onConfirm;
        showModal(elements.confirmationModal);
    };

    const hideConfirmationModal = () => {
        hideModal(elements.confirmationModal);
        onConfirmCallback = null;
    };
    
    elements.modalConfirmBtn.addEventListener('click', () => {
        if (onConfirmCallback) {
            onConfirmCallback();
        }
        hideConfirmationModal();
    });

    elements.modalCancelBtn.addEventListener('click', hideConfirmationModal);

    const showModal = (modalElement) => modalElement.classList.remove('hidden');
    const hideModal = (modalElement) => modalElement.classList.add('hidden');
    elements.batchCancelBtn.addEventListener('click', () => hideModal(elements.assignBatchModal));
    elements.quantityCancelBtn.addEventListener('click', () => hideModal(elements.editQuantityModal));

    const showToast = (message, type = 'success') => {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `position: fixed; top: -100px; left: 50%; transform: translateX(-50%); color: white; padding: 15px 25px; border-radius: 8px; z-index: 3000; opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); box-shadow: 0 4px 15px rgba(0,0,0,0.2); background-color: ${type === 'success' ? 'var(--success-color)' : 'var(--danger-color)'};`;
        document.body.appendChild(toast);
        setTimeout(() => { toast.style.top = '30px'; toast.style.opacity = '1'; }, 10);
        setTimeout(() => { toast.style.opacity = '0'; toast.style.top = '-100px'; setTimeout(() => toast.remove(), 500); }, 4000);
    };

    const exportToExcel = (data, fileName) => {
        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
        XLSX.writeFile(workbook, fileName);
    };

    const parseItemName = (itemName = '') => {
        let productName = itemName, color = 'نامشخص', size = 'تک سایز', productGroup = 'سایر';
        const knownSizes = ['S', 'M', 'L', 'XL', '2XL', '3XL', 'XXL', 'XS'];
        const sizeRegex = new RegExp(`\\b(${knownSizes.join('|')})\\b`, 'i');
        const groups = { 'هودی': 'هودی', 'تیشرت': 'تیشرت', 'بامبر': 'بامبر', 'دورس': 'دورس', 'شلوار': 'شلوار', 'سویشرت': 'سویشرت' };
        for (const key in groups) { if (itemName.includes(key)) { productGroup = groups[key]; break; } }
        const parts = productName.split(' - ');
        if (parts.length > 1) {
            productName = parts[0].trim();
            const details = parts[1].split(',').map(d => d.trim());
            let sizeFound = false;
            for (const detail of details) {
                const sizeMatch = detail.match(sizeRegex);
                if (sizeMatch && !sizeFound) { size = sizeMatch[0].toUpperCase(); sizeFound = true; } else { color = detail; }
            }
        }
        return { productName, color, size, productGroup };
    };
    
    // --- View Navigation ---
    const showView = (viewName) => {
        ['dashboardView', 'processingView', 'reportView', 'manualProductionView', 'printingView', 'trackingView', 'inventoryView', 'materialsView'].forEach(view => elements[view].classList.add('hidden'));
        elements[viewName].classList.remove('hidden');
    };
    elements.showDashboardBtn.addEventListener('click', () => showView('dashboardView'));
    elements.showManualProductionBtn.addEventListener('click', () => showView('manualProductionView'));
    elements.showReportBtn.addEventListener('click', () => { showView('reportView'); renderReportView(); });
    elements.showPrintingBtn.addEventListener('click', () => { showView('printingView'); renderPrintingView(); });
    elements.showTrackingBtn.addEventListener('click', () => { showView('trackingView'); renderTrackingView(); });
    elements.showInventoryBtn.addEventListener('click', () => { showView('inventoryView'); renderInventoryView(); });
    elements.showMaterialsBtn.addEventListener('click', () => { showView('materialsView'); renderMaterialsView(); });
    elements.backToDashboard.addEventListener('click', () => { appState.activeFileId = null; showView('dashboardView'); });

    // --- Data Management (Backup/Restore) ---
    elements.exportDataBtn.addEventListener('click', () => {
        try {
            const backupData = { ...appState };
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `production-dashboard-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('نسخه پشتیبان با موفقیت ایجاد شد.');
        } catch (err) {
            showToast(`خطا در ایجاد نسخه پشتیبان: ${err.message}`, 'error');
        }
    });
    
    elements.importDataBtn.addEventListener('click', () => elements.importFile.click());
    
    elements.importFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                if (!importedData.files || !importedData.productionLog) {
                    throw new Error('فایل پشتیبان معتبر نیست.');
                }
                showConfirmationModal('تایید بازیابی اطلاعات', 'آیا مطمئن هستید؟ تمام اطلاعات فعلی با اطلاعات فایل پشتیبان جایگزین خواهد شد. این عمل غیرقابل بازگشت است.', () => {
                    appState = importedData;
                    saveState();
                    showToast('اطلاعات با موفقیت بازیابی شد.');
                });
            } catch (err) {
                showToast(`خطا در بازیابی اطلاعات: ${err.message}`, 'error');
            } finally {
                e.target.value = ''; // Reset file input
            }
        };
        reader.readAsText(file);
    });


    // --- Dashboard View Logic ---
    const renderDashboard = () => {
        elements.fileList.innerHTML = '';
        if (Object.keys(appState.files).length === 0) {
            elements.fileList.innerHTML = '<p>هیچ فایلی برای نمایش وجود ندارد. لطفاً یک فایل جدید بارگذاری کنید.</p>'; return;
        }
        for (const fileId in appState.files) {
            const file = appState.files[fileId];
            const item = document.createElement('div');
            item.className = 'file-list-item';
            item.innerHTML = `<span><strong>(${file.shortId}) ${file.name}</strong></span><div><button class="btn-primary" data-id="${fileId}">مشاهده</button><button class="btn-danger" data-id="${fileId}">حذف</button></div>`;
            elements.fileList.appendChild(item);
        }
    };
    elements.fileList.addEventListener('click', (e) => {
        const fileId = e.target.dataset.id; if (!fileId) return;
        if (e.target.textContent === 'حذف') {
             showConfirmationModal(
                'تایید حذف فایل',
                `آیا از حذف فایل <strong>"${appState.files[fileId].name}"</strong> و تمام سوابق آن اطمینان دارید؟`,
                () => {
                    delete appState.files[fileId];
                    appState.productionLog = appState.productionLog.filter(log => log.sourceFileId !== fileId);
                    Object.keys(appState.productionBatches).forEach(batchCode => {
                        if(appState.productionBatches[batchCode].sourceFileId === fileId) delete appState.productionBatches[batchCode];
                    });
                    saveState(); 
                    showToast('فایل حذف شد.');
                }
            );
        } else if (e.target.textContent === 'مشاهده') {
            appState.activeFileId = fileId; showView('processingView'); renderProcessingView();
        }
    });
    elements.excelFile.addEventListener('change', (e) => {
        for (const file of e.target.files) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if (jsonData.length === 0) throw new Error('فایل خالی است.');
                    appState.fileCounter++; const fileShortId = `F${appState.fileCounter}`; const fileId = `file_${Date.now()}`;
                    const tasks = {};
                    jsonData.forEach((row) => {
                        const { SKU } = row; if(!SKU) return;
                        const quantity = parseInt(row['تعداد (- استرداد)'], 10) || 0; if(quantity <= 0) return;
                        const { productName, color, size, productGroup } = parseItemName(row['نام آیتم']);
                        const taskKey = `${SKU}-${productName}-${color}-${size}`;
                        if (!tasks[taskKey]) {
                            tasks[taskKey] = { uniqueId: `${fileShortId}-${SKU}-${productName.replace(/\s/g, '')}-${color.replace(/\s/g, '')}-${size}`, sku: SKU, productName, color, size, productGroup, quantity: 0, status: STATUSES.READY };
                        }
                        tasks[taskKey].quantity += quantity;
                    });
                    appState.files[fileId] = { id: fileId, shortId: fileShortId, name: file.name, uploadDate: new Date().toLocaleDateString('fa-IR'), tasks: Object.values(tasks) };
                    saveState(); showToast(`فایل "${file.name}" بارگذاری شد.`);
                } catch (err) { showToast(`خطا در پردازش: ${err.message}`, 'error');}
            };
            reader.readAsArrayBuffer(file);
        }
        e.target.value = '';
    });
    
    // --- Materials View Logic ---
    const renderMaterialsView = () => {
        // Render Materials Table
        const materialNames = Object.keys(appState.materials);
        let materialsTable = '<table><thead><tr><th>ماده اولیه</th><th>رنگ</th><th>موجودی</th><th>واحد</th><th>حذف</th></tr></thead><tbody>';
        if(materialNames.length > 0) {
            materialNames.forEach(name => {
                Object.keys(appState.materials[name]).forEach(color => {
                    const material = appState.materials[name][color];
                    materialsTable += `<tr><td>${name}</td><td>${color}</td><td>${material.stock}</td><td>${material.unit}</td><td><button class="btn-danger btn-sm" data-delete-material-name="${name}" data-delete-material-color="${color}">X</button></td></tr>`;
                });
            });
        } else {
            materialsTable += '<tr><td colspan="5">هیچ ماده اولیه‌ای تعریف نشده است.</td></tr>';
        }
        elements.materialsTableContainer.innerHTML = materialsTable + '</tbody></table>';

        // Render BOM Table
        let bomTable = '<table><thead><tr><th>گروه محصول</th><th>ماده اولیه</th><th>رنگ</th><th>میزان مصرف</th><th>حذف</th></tr></thead><tbody>';
        const bomGroups = Object.keys(appState.bom);
        if(bomGroups.length > 0) {
            bomGroups.forEach(group => {
                Object.keys(appState.bom[group]).forEach(materialName => {
                    Object.keys(appState.bom[group][materialName]).forEach(color => {
                        bomTable += `<tr><td>${group}</td><td>${materialName}</td><td>${color}</td><td>${appState.bom[group][materialName][color]}</td><td><button class="btn-danger btn-sm" data-delete-bom-group="${group}" data-delete-bom-material="${materialName}" data-delete-bom-color="${color}">X</button></td></tr>`;
                    });
                });
            });
        } else {
            bomTable += '<tr><td colspan="5">هیچ استاندارد مصرفی تعریف نشده است.</td></tr>';
        }
        elements.bomTableContainer.innerHTML = bomTable + '</tbody></table>';
        
        // Populate dropdowns
        const predefinedGroups = ['هودی', 'تیشرت', 'بامبر', 'دورس', 'شلوار', 'سویشرت', 'سایر'];
        const allGroups = new Set(predefinedGroups);
        Object.values(appState.files).forEach(file => file.tasks.forEach(task => allGroups.add(task.productGroup)));
        elements.bomGroupSelect.innerHTML = '<option value="">-- گروه محصول --</option>' + [...allGroups].sort().map(g => `<option>${g}</option>`).join('');
        elements.bomMaterialSelect.innerHTML = '<option value="">-- ماده اولیه --</option>' + materialNames.sort().map(m => `<option>${m}</option>`).join('');
        elements.bomMaterialColorSelect.innerHTML = '<option value="">-- رنگ ماده --</option>'; // Populated on material change
    };

    elements.bomMaterialSelect.addEventListener('change', (e) => {
        const materialName = e.target.value;
        const colors = materialName && appState.materials[materialName] ? Object.keys(appState.materials[materialName]) : [];
        elements.bomMaterialColorSelect.innerHTML = '<option value="">-- رنگ ماده --</option>' + colors.sort().map(c => `<option>${c}</option>`).join('');
    });
    
    elements.addMaterialBtn.addEventListener('click', () => {
        const name = elements.materialName.value.trim();
        const color = elements.materialColor.value.trim();
        const stock = parseInt(elements.materialStock.value, 10);
        const unit = elements.materialUnit.value.trim();
        if(!name || !color || isNaN(stock) || stock < 0 || !unit) {
            showToast('نام، رنگ، موجودی و واحد معتبر وارد کنید.', 'error');
            return;
        }
        if (!appState.materials[name]) {
            appState.materials[name] = {};
        }
        if (appState.materials[name][color]) {
            appState.materials[name][color].stock += stock;
        } else {
            appState.materials[name][color] = { stock, unit };
        }
        saveState();
        elements.materialName.value = '';
        elements.materialColor.value = '';
        elements.materialStock.value = '';
        elements.materialUnit.value = '';
    });
    
    elements.materialsTableContainer.addEventListener('click', e => {
        const materialName = e.target.dataset.deleteMaterialName;
        const materialColor = e.target.dataset.deleteMaterialColor;
        if(materialName && materialColor){
            showConfirmationModal(
                'تایید حذف ماده اولیه', 
                `آیا از حذف ماده اولیه '${materialName} - ${materialColor}' و تمام استانداردهای مصرف آن اطمینان دارید؟`,
                () => {
                    delete appState.materials[materialName][materialColor];
                    if(Object.keys(appState.materials[materialName]).length === 0) {
                        delete appState.materials[materialName];
                    }
                    Object.keys(appState.bom).forEach(group => {
                        if(appState.bom[group][materialName] && appState.bom[group][materialName][materialColor]){
                            delete appState.bom[group][materialName][materialColor];
                             if(Object.keys(appState.bom[group][materialName]).length === 0) {
                                delete appState.bom[group][materialName];
                            }
                        }
                    });
                    saveState();
                    showToast(`ماده اولیه '${materialName} - ${materialColor}' حذف شد.`);
                }
            );
        }
    });

    elements.addBomBtn.addEventListener('click', () => {
        const group = elements.bomGroupSelect.value;
        const materialName = elements.bomMaterialSelect.value;
        const materialColor = elements.bomMaterialColorSelect.value;
        const consumption = parseFloat(elements.bomConsumptionInput.value);
        if(!group || !materialName || !materialColor || isNaN(consumption) || consumption <= 0){
            showToast('لطفا تمام فیلدهای استاندارد مصرف را به درستی پر کنید.', 'error');
            return;
        }
        if(!appState.bom[group]){
            appState.bom[group] = {};
        }
        if(!appState.bom[group][materialName]){
            appState.bom[group][materialName] = {};
        }
        appState.bom[group][materialName][materialColor] = consumption;
        saveState();
        elements.bomConsumptionInput.value = '';
    });

    elements.bomTableContainer.addEventListener('click', e => {
        const group = e.target.dataset.deleteBomGroup;
        const material = e.target.dataset.deleteBomMaterial;
        const color = e.target.dataset.deleteBomColor;
        if(group && material && color){
            showConfirmationModal(
                'تایید حذف استاندارد',
                `آیا از حذف این استاندارد مصرف اطمینان دارید؟`,
                 () => {
                    delete appState.bom[group][material][color];
                    if(Object.keys(appState.bom[group][material]).length === 0){
                        delete appState.bom[group][material];
                    }
                    if(Object.keys(appState.bom[group]).length === 0){
                        delete appState.bom[group];
                    }
                    saveState();
                 }
            );
        }
    });

    elements.materialsExcelFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (jsonData.length === 0) throw new Error('فایل خالی است.');
                let updatedCount = 0;
                jsonData.forEach(row => {
                    const name = row['نام مواد اولیه'];
                    const color = row['رنگ'] || 'نامشخص';
                    const stock = parseFloat(row['مقدار']);
                    const unit = row['واحد سنجش'];
                    if (name && !isNaN(stock) && unit) {
                        const materialName = name.trim();
                        const materialColor = color.trim();
                        if (!appState.materials[materialName]) {
                            appState.materials[materialName] = {};
                        }
                        if (appState.materials[materialName][materialColor]) {
                            appState.materials[materialName][materialColor].stock += stock;
                        } else {
                            appState.materials[materialName][materialColor] = { stock, unit: unit.trim() };
                        }
                        updatedCount++;
                    }
                });
                if (updatedCount > 0) {
                    saveState();
                    showToast(`${updatedCount} ماده اولیه با موفقیت اضافه/به‌روزرسانی شد.`);
                } else {
                     showToast('هیچ ردیف معتبری در فایل اکسل یافت نشد. ستون‌ها باید "نام مواد اولیه"، "رنگ"، "مقدار" و "واحد سنجش" باشند.', 'error');
                }
            } catch (err) {
                showToast(`خطا در پردازش فایل: ${err.message}`, 'error');
            }
        };
        reader.readAsArrayBuffer(file);
        e.target.value = '';
    });


    // --- Inventory View Logic ---
    const renderInventoryView = () => {
        elements.inventoryTableContainer.innerHTML = '';
        const inventoryGroups = Object.keys(appState.inventory);
        if (inventoryGroups.length === 0) {
            elements.inventoryTableContainer.innerHTML = '<p>موجودی انبار خالی است. لطفا فایل موجودی را بارگذاری کنید.</p>';
            return;
        }
        let tableHTML = '<h3>موجودی دقیق محصولات</h3><table><thead><tr><th>گروه محصول</th><th>رنگ</th><th>سایز</th><th>تعداد موجودی</th></tr></thead><tbody>';
        let hasItems = false;
        for (const group of inventoryGroups.sort()) {
            for (const color of Object.keys(appState.inventory[group]).sort()) {
                for (const size of Object.keys(appState.inventory[group][color]).sort()) {
                    const quantity = appState.inventory[group][color][size];
                    if (quantity > 0) {
                        tableHTML += `<tr><td>${group}</td><td>${color}</td><td>${size}</td><td><strong>${quantity}</strong></td></tr>`;
                        hasItems = true;
                    }
                }
            }
        }
        if (!hasItems) {
            elements.inventoryTableContainer.innerHTML = '<p>موجودی انبار خالی است.</p>';
            return;
        }
        tableHTML += '</tbody></table>';
        elements.inventoryTableContainer.innerHTML = tableHTML;
    };
    elements.inventoryExcelFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (jsonData.length === 0) throw new Error('فایل موجودی خالی است.');
                let updatedCount = 0;
                jsonData.forEach(row => {
                    const quantity = parseInt(row['تعداد (- استرداد)'], 10) || 0;
                    const itemName = row['نام آیتم'];
                    if (quantity !== 0 && itemName) {
                        const { productGroup, color, size } = parseItemName(itemName);
                        
                        if (!appState.inventory[productGroup]) {
                            appState.inventory[productGroup] = {};
                        }
                        if (!appState.inventory[productGroup][color]) {
                            appState.inventory[productGroup][color] = {};
                        }
                        
                        appState.inventory[productGroup][color][size] = (appState.inventory[productGroup][color][size] || 0) + quantity;
                        updatedCount++;
                    }
                });
                if (updatedCount > 0) {
                    saveState();
                    showToast('فایل موجودی با موفقیت بارگذاری و مقادیر به موجودی فعلی اضافه/کسر شد.');
                }
            } catch (err) {
                showToast(`خطا در پردازش فایل موجودی: ${err.message}`, 'error');
            }
        };
        reader.readAsArrayBuffer(file);
        e.target.value = '';
    });

    // --- Manual Production View ---
    const renderManualItemsTable = () => {
        if(manualOrderItems.length === 0) { elements.manualItemsTableContainer.innerHTML = '<p>هنوز آیتمی اضافه نشده است.</p>'; return; }
        let tableHTML = '<table><thead><tr><th>محصول</th><th>کد طرح</th><th>رنگ</th><th>سایز</th><th>تعداد</th><th>حذف</th></tr></thead><tbody>';
        manualOrderItems.forEach((item, index) => {
            tableHTML += `<tr><td>${item.productName}</td><td>${item.sku}</td><td>${item.color}</td><td>${item.size}</td><td>${item.quantity}</td><td><button class="btn-danger" data-index="${index}">X</button></td></tr>`;
        });
        elements.manualItemsTableContainer.innerHTML = tableHTML + '</tbody></table>';
    };
    elements.addItemToManualListBtn.addEventListener('click', () => {
        const item = {
            productName: document.getElementById('manualProductName').value.trim(),
            sku: document.getElementById('manualSku').value.trim(),
            color: document.getElementById('manualColor').value.trim(),
            size: document.getElementById('manualSize').value,
            quantity: parseInt(document.getElementById('manualQuantity').value, 10),
            productGroup: document.getElementById('manualGroup').value,
        };
        if(!item.productName || !item.sku || !item.color || !item.size || !item.quantity || !item.productGroup) { showToast('لطفا تمام فیلدها را پر کنید.', 'error'); return; }
        manualOrderItems.push({ ...item, status: STATUSES.IN_PROGRESS });
        renderManualItemsTable(); elements.manualForm.reset();
    });
    elements.manualItemsTableContainer.addEventListener('click', (e) => {
        if(e.target.classList.contains('btn-danger')) {
            manualOrderItems.splice(parseInt(e.target.dataset.index, 10), 1); renderManualItemsTable();
        }
    });
    elements.saveManualOrderBtn.addEventListener('click', () => {
        if(manualOrderItems.length === 0) { showToast('هیچ آیتمی برای ذخیره وجود ندارد.', 'error'); return; }
        const orderId = `MANUAL-${Date.now()}`; const orderDate = new Date().toLocaleString('fa-IR');
        manualOrderItems.forEach(item => {
            appState.productionLog.push({ ...item, logId: `${orderId}-${item.sku}-${item.size}`, orderId, orderDate, sourceFileId: 'manual', sourceFileShortId: 'دستی' });
        });
        saveState(); showToast(`${manualOrderItems.length} آیتم دستی ذخیره شد.`); manualOrderItems = []; renderManualItemsTable();
    });
    elements.clearManualOrderBtn.addEventListener('click', () => {
        if(manualOrderItems.length > 0){
             showConfirmationModal(
                'پاک کردن لیست',
                'آیا از پاک کردن لیست فعلی اطمینان دارید؟',
                () => {
                    manualOrderItems = []; 
                    renderManualItemsTable();
                    showToast('لیست پاک شد.');
                }
            );
        }
    });

    // --- Processing View Logic (File based) ---
    const renderProcessingView = () => {
        const file = appState.files[appState.activeFileId];
        elements.processingFileName.textContent = `پردازش فایل: (${file.shortId}) ${file.name}`;
        const tasks = file.tasks;
        const groups = [...new Set(tasks.map(t=>t.productGroup))];
        const colors = [...new Set(tasks.map(t=>t.color))];
        const sizes = [...new Set(tasks.map(t=>t.size))];
        elements.groupFilter.innerHTML = '<option value="">همه</option>' + groups.map(g => `<option>${g}</option>`).join('');
        elements.colorFilter.innerHTML = '<option value="">همه</option>' + colors.map(c => `<option>${c}</option>`).join('');
        elements.sizeFilter.innerHTML = '<option value="">همه</option>' + sizes.map(s => `<option>${s}</option>`).join('');
        applyProcessingFilters();
    };
    const applyProcessingFilters = () => {
        if (!appState.activeFileId) return;
        const file = appState.files[appState.activeFileId];
        const group = elements.groupFilter.value, color = elements.colorFilter.value, size = elements.sizeFilter.value, status = elements.processingStatusFilter.value;
        const filtered = file.tasks.filter(t => (!group || t.productGroup === group) && (!color || t.color === color) && (!size || t.size === size) && (!status || t.status === status));
        filtered.sort((a, b) => (String(a.sku)).localeCompare(String(b.sku), undefined, { numeric: true }));
        renderTasksTable(filtered); renderSummaryCards(filtered, elements.summaryCards, 'فیلتر');
    };
    [elements.groupFilter, elements.colorFilter, elements.sizeFilter, elements.processingStatusFilter].forEach(el => el.addEventListener('change', applyProcessingFilters));

    const renderSummaryCards = (items, container, scope) => {
        const totals = { total: 0, [STATUSES.READY]: 0, [STATUSES.IN_PROGRESS]: 0, [STATUSES.PRINTING]: 0, [STATUSES.DONE]: 0, [STATUSES.CANCELLED]: 0 };
        items.forEach(item => { 
            totals[item.status] = (totals[item.status] || 0) + item.quantity; 
            if (item.status !== STATUSES.CANCELLED) {
                totals.total += item.quantity;
            }
        });
        container.innerHTML = `<div class="card card-total"><h4>جمع کل (${scope})</h4><div class="count">${totals.total}</div></div>
            <div class="card card-ready"><h4>آماده</h4><div class="count">${totals[STATUSES.READY] || 0}</div></div>
            <div class="card card-inprogress"><h4>درحال انجام</h4><div class="count">${totals[STATUSES.IN_PROGRESS] || 0}</div></div>
            <div class="card" style="border-color: var(--inventory-color);"><h4>در دست چاپ</h4><div class="count">${totals[STATUSES.PRINTING] || 0}</div></div>
            <div class="card card-done"><h4>انجام شده</h4><div class="count">${totals[STATUSES.DONE] || 0}</div></div>
            <div class="card" style="border-color: var(--danger-color);"><h4>ابطال شده</h4><div class="count">${totals[STATUSES.CANCELLED] || 0}</div></div>`;
    };

    const renderTasksTable = (tasks) => {
        let tableHTML = `<table><thead><tr><th><input type="checkbox" id="selectAllTasks"></th><th>کد طرح</th><th>کالا</th><th>گروه</th><th>رنگ</th><th>سایز</th><th>تعداد</th><th>وضعیت</th></tr></thead><tbody>`;
        tasks.forEach(task => {
            let statusClass = '';
            switch(task.status) {
                case STATUSES.READY: statusClass = 'status-ready'; break;
                case STATUSES.IN_PROGRESS: statusClass = 'status-inprogress'; break;
                case STATUSES.PRINTING: statusClass = 'status-printing'; break;
                case STATUSES.DONE: statusClass = 'status-done'; break;
                case STATUSES.CANCELLED: statusClass = 'status-cancelled'; break;
            }
            tableHTML += `<tr class="${statusClass}"><td><input type="checkbox" class="task-selector" data-id="${task.uniqueId}" ${task.status !== STATUSES.READY ? 'disabled' : ''}></td><td>${task.sku}</td><td>${task.productName}</td><td>${task.productGroup}</td><td>${task.color}</td><td>${task.size}</td><td><b>${task.quantity}</b></td><td>${task.status}</td></tr>`;
        });
        elements.tasksTableContainer.innerHTML = tableHTML + `</tbody></table>`;
        document.getElementById('selectAllTasks').addEventListener('change', (e) => document.querySelectorAll('.task-selector:not(:disabled)').forEach(chk => chk.checked = e.target.checked));
    };
    elements.createProductionOrderBtn.addEventListener('click', () => {
        const selectedIds = new Set([...document.querySelectorAll('.task-selector:checked')].map(chk => chk.dataset.id));
        if (selectedIds.size === 0) { showToast('هیچ وظیفه‌ آماده‌ای انتخاب نشده.', 'error'); return; }
        const file = appState.files[appState.activeFileId];
        const itemsToEdit = file.tasks.filter(task => selectedIds.has(task.uniqueId));
        
        let warningHTML = '<h4>آنالیز موجودی محصول آماده:</h4>';
        itemsToEdit.forEach(task => {
            const { productGroup, color, size, quantity, productName } = task;
            const available = appState.inventory[productGroup]?.[color]?.[size] || 0;
            const neededToProduce = Math.max(0, quantity - available);
            warningHTML += `<p class="${neededToProduce > 0 ? 'low-inventory' : ''}">
                '${productName} - ${color} - ${size}': 
                نیاز کل <strong>${quantity}</strong> / 
                موجودی آماده <strong>${available}</strong> / 
                <strong>نیاز به تولید: ${neededToProduce}</strong>
            </p>`;
        });
       
        warningHTML += '<hr style="margin: 15px 0;"><h4>آنالیز مواد اولیه مورد نیاز (بر اساس رنگ):</h4>';

        const requiredMaterials = {}; // { 'MaterialName': { 'Color': { required, available, unit } } }
        
        itemsToEdit.forEach(item => {
            const bomForGroup = appState.bom[item.productGroup];
            if (bomForGroup) {
                for (const materialName in bomForGroup) {
                    const bomForMaterial = bomForGroup[materialName];
                    const consumption = bomForMaterial[item.color] || bomForMaterial['نامشخص']; // Match product color or use a generic one
                    
                    if (consumption) {
                         if (!requiredMaterials[materialName]) requiredMaterials[materialName] = {};
                         const color = item.color;
                         if (!requiredMaterials[materialName][color]) {
                             const materialData = appState.materials[materialName]?.[color] || { stock: 0, unit: '??' };
                             requiredMaterials[materialName][color] = { required: 0, available: materialData.stock, unit: materialData.unit };
                         }
                         requiredMaterials[materialName][color].required += item.quantity * consumption;
                    }
                }
            }
        });

        if (Object.keys(requiredMaterials).length > 0) {
            Object.keys(requiredMaterials).sort().forEach(materialName => {
                Object.keys(requiredMaterials[materialName]).sort().forEach(color => {
                    const data = requiredMaterials[materialName][color];
                    warningHTML += `<p class="${data.required > data.available ? 'low-inventory' : ''}">ماده '${materialName} - ${color}': نیاز <strong>${data.required.toFixed(2)}</strong> ${data.unit} / موجودی <strong>${data.available}</strong> ${data.unit}</p>`;
                });
            });
        } else {
            warningHTML += '<p>هیچ استاندارد مصرفی برای گروه‌ها و رنگ‌های محصول انتخابی تعریف نشده است.</p>';
        }

        elements.inventoryWarningContainer.innerHTML = warningHTML;
        
        elements.editQuantityList.innerHTML = '';
        itemsToEdit.forEach(task => {
            elements.editQuantityList.insertAdjacentHTML('beforeend', `
                <div class="edit-quantity-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                    <span>${task.productName} - ${task.color} - ${task.size} (موجود: ${task.quantity})</span>
                    <input type="number" class="quantity-input" data-id="${task.uniqueId}" value="${task.quantity}" min="0" max="${task.quantity}" style="width: 80px; padding: 5px;">
                </div>`);
        });
        showModal(elements.editQuantityModal);
    });

    elements.quantityConfirmBtn.addEventListener('click', () => {
        const inputs = document.querySelectorAll('#editQuantityList .quantity-input');
        const orderId = `PROD-${Date.now()}`;
        const orderDate = new Date().toLocaleString('fa-IR');
        let itemsAdded = 0;
        const file = appState.files[appState.activeFileId];

        inputs.forEach(input => {
            const uniqueId = input.dataset.id;
            const quantityToSend = parseInt(input.value, 10);
            if (isNaN(quantityToSend) || quantityToSend < 0) return;

            const originalTask = file.tasks.find(t => t.uniqueId === uniqueId);
            if (!originalTask || quantityToSend > originalTask.quantity) return;
            
            if (quantityToSend > 0) {
                appState.productionLog.push({ ...originalTask, status: STATUSES.IN_PROGRESS, quantity: quantityToSend, logId: `${orderId}-${uniqueId}-${Date.now()}`, orderId, orderDate, sourceFileId: appState.activeFileId, sourceFileShortId: file.shortId });
                
                const bomForGroup = appState.bom[originalTask.productGroup];
                if(bomForGroup){
                    for (const materialName in bomForGroup) {
                        const bomForMaterial = bomForGroup[materialName];
                        const consumption = bomForMaterial[originalTask.color] || bomForMaterial['نامشخص'];
                        
                        if (consumption && appState.materials[materialName] && appState.materials[materialName][originalTask.color]) {
                            appState.materials[materialName][originalTask.color].stock -= (quantityToSend * consumption);
                        }
                    }
                }
                itemsAdded++;
            }
           
            originalTask.quantity -= quantityToSend;
            if (originalTask.quantity === 0) {
                 originalTask.status = STATUSES.DONE;
            }
        });
        if (itemsAdded > 0) {
            showToast(`${itemsAdded} دستور تولید جدید صادر شد.`);
        }
        
        saveState(); 
        applyProcessingFilters(); 
        hideModal(elements.editQuantityModal);
    });

    // --- Report View Logic ---
    const renderReportView = () => {
        const files = Object.values(appState.files);
        const hasManual = appState.productionLog.some(log => log.sourceFileId === 'manual');
        let fileOptions = files.map(f => `<option value="${f.id}">${f.shortId} - ${f.name}</option>`).join('');
        if(hasManual) fileOptions += '<option value="manual">تولید دستی (کارمزدی)</option>';
        elements.reportFileFilter.innerHTML = '<option value="">همه فایل‌ها</option>' + fileOptions;
        const groups = [...new Set(appState.productionLog.map(l=>l.productGroup))];
        
        elements.reportGroupFilter.innerHTML = '<option value="">همه</option>' + groups.sort().map(g => `<option>${g}</option>`).join('');
        
        applyReportFilters();
    };
    let currentFilteredLog = [];
    const applyReportFilters = () => {
        const file = elements.reportFileFilter.value, status = elements.reportStatusFilter.value, group = elements.reportGroupFilter.value;
        const batchSearch = elements.reportBatchSearch.value.toLowerCase();
        const batchStatus = elements.reportBatchFilter.value;
        
        currentFilteredLog = appState.productionLog.filter(l => 
            (!file || l.sourceFileId === file) && 
            (!status || l.status === status) && 
            (!group || l.productGroup === group) &&
            (!batchSearch || (l.batchCode && l.batchCode.toLowerCase().includes(batchSearch))) &&
            (batchStatus === '' || (batchStatus === 'assigned' && l.batchCode) || (batchStatus === 'unassigned' && !l.batchCode))
        );
        renderReportTable(currentFilteredLog); renderSummaryCards(currentFilteredLog, elements.reportSummaryCards, "گزارش");
    };
    [elements.reportFileFilter, elements.reportStatusFilter, elements.reportGroupFilter, elements.reportBatchFilter, elements.reportBatchSearch].forEach(el => {
        el.addEventListener('change', applyReportFilters);
        el.addEventListener('input', applyReportFilters);
    });
    
    const renderReportTable = (logData) => {
        let tableHTML = `<table><thead><tr>
            <th><input type="checkbox" id="selectAllReport"></th><th>منبع</th><th>نام فایل</th><th>کد بچ</th><th>تاریخ</th><th>کد طرح</th><th>کالا</th><th>گروه</th><th>رنگ</th><th>سایز</th><th>تعداد</th><th>وضعیت</th>
            </tr></thead><tbody>`;
        logData.forEach(log => {
            const fileName = log.sourceFileId === 'manual' ? 'تولید دستی' : (appState.files[log.sourceFileId]?.name || 'نامشخص');
            const batchClass = log.batchCode ? 'has-batch-code' : '';
            let statusClass = '';
            switch(log.status) {
                case STATUSES.IN_PROGRESS: statusClass = 'status-inprogress'; break;
                case STATUSES.PRINTING: statusClass = 'status-printing'; break;
                case STATUSES.DONE: statusClass = 'status-done'; break;
                case STATUSES.CANCELLED: statusClass = 'status-cancelled'; break;
            }
            tableHTML += `<tr class="${batchClass} ${statusClass}"><td><input type="checkbox" class="report-selector" data-id="${log.logId}" ${log.status === STATUSES.PRINTING ? 'disabled' : ''}></td><td>${log.sourceFileShortId}</td><td>${fileName}</td><td>${log.batchCode || '-'}</td><td>${log.orderDate}</td><td>${log.sku}</td><td>${log.productName}</td><td>${log.productGroup}</td><td>${log.color}</td><td>${log.size}</td><td><b>${log.quantity}</b></td><td>${log.status}</td></tr>`;
        });
        elements.reportTableContainer.innerHTML = tableHTML + `</tbody></table>`;
        document.getElementById('selectAllReport').addEventListener('change', (e) => document.querySelectorAll('.report-selector:not(:disabled)').forEach(chk => chk.checked = e.target.checked));
    };

    elements.sendToPrintingBtn.addEventListener('click', () => {
        const selectedIds = new Set([...document.querySelectorAll('.report-selector:checked:not(:disabled)')].map(chk => chk.dataset.id));
        if (selectedIds.size === 0) {
            showToast('موردی برای ارسال به چاپ انتخاب نشده.', 'error');
            return;
        }

        let changedCount = 0;
        const itemsToChange = appState.productionLog.filter(log => selectedIds.has(log.logId));
        
        const invalidItems = itemsToChange.filter(item => item.status !== STATUSES.IN_PROGRESS || item.batchCode);
        if(invalidItems.length > 0) {
            showToast('فقط آیتم‌های "درحال انجام" و بدون کد بچ را می‌توان برای چاپ ارسال کرد.', 'error');
            return;
        }

        itemsToChange.forEach(log => {
            log.status = STATUSES.PRINTING;
            changedCount++;
        });

        if (changedCount > 0) {
            saveState();
            showToast(`${changedCount} مورد برای چاپ ارسال شد.`);
        }
    });

    elements.reportBulkUpdateBtn.addEventListener('click', () => {
        const toStatus = elements.reportToStatus.value;
        const selectedIds = new Set([...document.querySelectorAll('.report-selector:checked')].map(chk => chk.dataset.id));
        if (selectedIds.size === 0) {
            showToast('موردی انتخاب نشده.', 'error');
            return;
        }

        const itemsToChange = appState.productionLog.filter(log => selectedIds.has(log.logId));
        let changedCount = 0;

        if (toStatus === STATUSES.READY) {
            if (itemsToChange.some(item => item.sourceFileId === 'manual')) {
                showToast('امکان بازگشت به "آماده تولید" برای آیتم‌های دستی وجود ندارد.', 'error');
                return;
            }

            const logIdsToRemoveFromProdLog = new Set();
            itemsToChange.forEach(log => {
                const file = appState.files[log.sourceFileId];
                if (file) {
                    const task = file.tasks.find(t => t.uniqueId === log.uniqueId);
                    if (task) {
                        task.quantity += log.quantity;
                        if (task.status === STATUSES.DONE) task.status = STATUSES.READY;
                    }
                    logIdsToRemoveFromProdLog.add(log.logId);
                    changedCount++;
                }
            });

            if (changedCount > 0) {
                appState.productionLog = appState.productionLog.filter(log => !logIdsToRemoveFromProdLog.has(log.logId));
                const allRemainingLogIds = new Set(appState.productionLog.map(l => l.logId));
                for (const batchCode in appState.productionBatches) {
                    const batch = appState.productionBatches[batchCode];
                    batch.logIds = batch.logIds.filter(id => allRemainingLogIds.has(id));
                    if (batch.logIds.length === 0) {
                        delete appState.productionBatches[batchCode];
                    }
                }
                saveState();
                showToast(`${changedCount} مورد به "آماده تولید" بازگشت داده شد.`);
            }
        } else {
            itemsToChange.forEach(log => {
                log.status = toStatus;
                changedCount++;
            });
            if (changedCount > 0) {
                saveState();
                showToast(`${changedCount} مورد به وضعیت "${toStatus}" تغییر یافت.`);
            }
        }
    });
    
    elements.assignBatchCodeBtn.addEventListener('click', () => {
        const selectedIds = new Set([...document.querySelectorAll('.report-selector:checked')].map(chk => chk.dataset.id));
        if (selectedIds.size === 0) { showToast('موردی برای اختصاص کد بچ انتخاب نشده.', 'error'); return; }
        
        const invalidItems = appState.productionLog.filter(log => selectedIds.has(log.logId) && (log.batchCode || log.status !== STATUSES.IN_PROGRESS));
        if(invalidItems.length > 0) {
            showToast('فقط آیتم‌های "درحال انجام" و بدون کد بچ را می‌توان انتخاب کرد.', 'error');
            return;
        }

        const currentYear = new Date().toLocaleDateString('fa-IR', {year: 'numeric'});
        const months = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
        elements.batchDeliveryYear.innerHTML = `<option>${currentYear}</option><option>${parseInt(currentYear)+1}</option>`;
        elements.batchDeliveryMonth.innerHTML = months.map((m, i) => `<option value="${i+1}">${m}</option>`).join('');
        elements.batchDeliveryDay.innerHTML = Array.from({length: 31}, (_, i) => `<option>${i+1}</option>`).join('');
        
        const currentMonthName = new Date().toLocaleDateString('fa-IR', { month: 'long' });
        const selectedItems = appState.productionLog.filter(log => selectedIds.has(log.logId));
        const isCommission = selectedItems.every(item => item.sourceFileId === 'manual');
        let counter, prefix;
        if (isCommission) {
            prefix = "K";
            if(appState.batchMonthK !== currentMonthName) { appState.batchMonthK = currentMonthName; appState.batchCounterK = 1; }
            counter = appState.batchCounterK;
        } else {
            prefix = "A";
            if(appState.batchMonthA !== currentMonthName) { appState.batchMonthA = currentMonthName; appState.batchCounterA = 1; }
            counter = appState.batchCounterA;
        }
        elements.batchCodeInput.value = `${prefix}${currentMonthName}${String(counter).padStart(2, '0')}`;
        
        elements.assignBatchModalTitle.textContent = `اختصاص کد بچ به ${selectedIds.size} آیتم`;
        showModal(elements.assignBatchModal);
    });

    elements.batchConfirmBtn.addEventListener('click', () => {
        const batchCode = elements.batchCodeInput.value.trim();
        const deliveryDate = `${elements.batchDeliveryYear.value}/${elements.batchDeliveryMonth.value}/${elements.batchDeliveryDay.value}`;
        if(!batchCode || !deliveryDate) { showToast('کد بچ و تاریخ تحویل را مشخص کنید.', 'error'); return; }
        if(appState.productionBatches[batchCode]) { showToast('این کد بچ قبلا استفاده شده.', 'error'); return; }
        
        const selectedIds = new Set([...document.querySelectorAll('.report-selector:checked')].map(chk => chk.dataset.id));
        const selectedLogs = appState.productionLog.filter(log => selectedIds.has(log.logId));
        selectedLogs.forEach(log => { log.batchCode = batchCode; log.deliveryDate = deliveryDate; });
        
        const isCommission = selectedLogs.every(item => item.sourceFileId === 'manual');
        if (isCommission) { appState.batchCounterK++; } else { appState.batchCounterA++; }
        
        appState.productionBatches[batchCode] = {
            code: batchCode,
            creationDate: new Date().toISOString(),
            deliveryDate,
            logIds: [...selectedIds],
            sourceFileId: selectedLogs[0].sourceFileId,
            sourceFileShortId: selectedLogs[0].sourceFileShortId,
            stages: Object.keys(PRODUCTION_STAGES).reduce((acc, stage) => ({...acc, [stage]: false}), {}),
            isCompleted: false
        };
        
        saveState(); showToast(`کد بچ ${batchCode} به ${selectedIds.size} آیتم اختصاص یافت.`); hideModal(elements.assignBatchModal);
    });
    
    elements.exportReportBtn.addEventListener('click', () => {
        if (currentFilteredLog.length === 0) { showToast('داده‌ای برای خروجی وجود ندارد.', 'error'); return; }
        const dataToExport = currentFilteredLog.map(log => ({
            'منبع': log.sourceFileShortId, 'نام فایل': log.sourceFileId === 'manual' ? 'تولید دستی' : (appState.files[log.sourceFileId]?.name || 'نامشخص'),
            'کد بچ': log.batchCode, 'تاریخ سفارش': log.orderDate, 'تاریخ تحویل': log.deliveryDate, 'کد طرح': log.sku,
            'کالا': log.productName, 'گروه': log.productGroup, 'رنگ': log.color, 'سایز': log.size, 'تعداد': log.quantity, 'وضعیت': log.status
        }));
        exportToExcel(dataToExport, `Report-${new Date().toLocaleDateString('fa-IR').replace(/\//g, '-')}.xlsx`);
    });


    // --- Printing View Logic ---
    let currentFilteredPrintingLog = [];
    const renderPrintingView = () => {
        const printingLogs = appState.productionLog.filter(log => log.status === STATUSES.PRINTING);
        const files = [...new Set(printingLogs.map(log => log.sourceFileId))];
        const groups = [...new Set(printingLogs.map(log => log.productGroup))];
        const colors = [...new Set(printingLogs.map(log => log.color))];
        const sizes = [...new Set(printingLogs.map(log => log.size))];
        
        let fileOptions = files.map(id => {
            const name = id === 'manual' ? 'تولید دستی' : (appState.files[id]?.name || `فایل ${id}`);
            const shortId = id === 'manual' ? 'دستی' : (appState.files[id]?.shortId || '?');
            return `<option value="${id}">${shortId} - ${name}</option>`;
        }).join('');
        
        elements.printingFileFilter.innerHTML = '<option value="">همه فایل‌ها</option>' + fileOptions;
        elements.printingGroupFilter.innerHTML = '<option value="">همه گروه‌ها</option>' + groups.sort().map(g => `<option>${g}</option>`).join('');
        elements.printingColorFilter.innerHTML = '<option value="">همه رنگ‌ها</option>' + colors.sort().map(c => `<option>${c}</option>`).join('');
        elements.printingSizeFilter.innerHTML = '<option value="">همه سایزها</option>' + sizes.sort().map(s => `<option>${s}</option>`).join('');
        
        applyPrintingFilters();
    };

    const applyPrintingFilters = () => {
        const file = elements.printingFileFilter.value, group = elements.printingGroupFilter.value, color = elements.printingColorFilter.value, size = elements.printingSizeFilter.value;
        currentFilteredPrintingLog = appState.productionLog.filter(log => 
            log.status === STATUSES.PRINTING &&
            (!file || log.sourceFileId === file) && 
            (!group || log.productGroup === group) &&
            (!color || log.color === color) &&
            (!size || log.size === size)
        );
        renderPrintingTable(currentFilteredPrintingLog);
        renderSummaryCards(currentFilteredPrintingLog, elements.printingSummaryCards, "در دست چاپ");
    };

    [elements.printingFileFilter, elements.printingGroupFilter, elements.printingColorFilter, elements.printingSizeFilter].forEach(el => el.addEventListener('change', applyPrintingFilters));

    const renderPrintingTable = (logData) => {
        let tableHTML = `<table><thead><tr>
            <th><input type="checkbox" id="selectAllPrinting"></th><th>منبع</th><th>کد طرح</th><th>کالا</th><th>گروه</th><th>رنگ</th><th>سایز</th><th>تعداد</th>
            </tr></thead><tbody>`;
        logData.forEach(log => {
            tableHTML += `<tr class="status-printing"><td><input type="checkbox" class="printing-selector" data-id="${log.logId}"></td><td>${log.sourceFileShortId}</td><td>${log.sku}</td><td>${log.productName}</td><td>${log.productGroup}</td><td>${log.color}</td><td>${log.size}</td><td><b>${log.quantity}</b></td></tr>`;
        });
        elements.printingTableContainer.innerHTML = tableHTML + `</tbody></table>`;
        document.getElementById('selectAllPrinting').addEventListener('change', (e) => document.querySelectorAll('.printing-selector').forEach(chk => chk.checked = e.target.checked));
    };
    
    elements.printingBulkUpdateBtn.addEventListener('click', () => {
        const selectedIds = new Set([...document.querySelectorAll('.printing-selector:checked')].map(chk => chk.dataset.id));
        if (selectedIds.size === 0) {
            showToast('موردی برای تغییر وضعیت انتخاب نشده.', 'error');
            return;
        }
        let changedCount = 0;
        appState.productionLog.forEach(log => {
            if (selectedIds.has(log.logId)) {
                log.status = STATUSES.IN_PROGRESS; // Return to in-progress for batch assignment
                changedCount++;
            }
        });
        if (changedCount > 0) {
            saveState();
            showToast(`${changedCount} مورد به "درحال انجام" بازگردانده شد.`);
        }
    });

    elements.exportPrintingBtn.addEventListener('click', () => {
        if (currentFilteredPrintingLog.length === 0) { showToast('داده‌ای برای خروجی وجود ندارد.', 'error'); return; }
        const dataToExport = currentFilteredPrintingLog.map(log => ({
            'منبع': log.sourceFileShortId, 'کد طرح': log.sku, 'کالا': log.productName,
            'گروه': log.productGroup, 'رنگ': log.color, 'سایز': log.size, 'تعداد': log.quantity
        }));
        exportToExcel(dataToExport, `Printing-List-${new Date().toLocaleDateString('fa-IR').replace(/\//g, '-')}.xlsx`);
    });

    const printContent = (el) => {
        const clonedEl = el.cloneNode(true);
        const table = clonedEl.querySelector('table');
        if (table) {
            // Remove checkboxes for printing
            table.querySelectorAll('input[type="checkbox"]').forEach(chk => {
                const parent = chk.parentElement;
                if(parent.tagName === 'TH' || parent.tagName === 'TD') parent.remove();
            });
             // Aggregate by Group, Color, Size
            const aggregated = {};
            currentFilteredPrintingLog.forEach(item => {
                const key = `${item.productGroup}-${item.color}-${item.size}`;
                if(!aggregated[key]) {
                    aggregated[key] = { ...item, quantity: 0 };
                }
                aggregated[key].quantity += item.quantity;
            });

            let newTbody = '<tbody>';
            Object.values(aggregated).sort((a,b) => a.productGroup.localeCompare(b.productGroup)).forEach(agg => {
                 newTbody += `<tr>
                    <td>${agg.sourceFileShortId}</td>
                    <td>${agg.sku}</td>
                    <td>${agg.productName}</td>
                    <td>${agg.productGroup}</td>
                    <td>${agg.color}</td>
                    <td>${agg.size}</td>
                    <td><b>${agg.quantity}</b></td>
                </tr>`;
            });
            table.querySelector('tbody').innerHTML = newTbody;
        }

        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Print</title>');
        printWindow.document.write('<style>body{font-family: Vazirmatn, sans-serif; direction: rtl;} table{width: 100%; border-collapse: collapse;} th,td{border: 1px solid #ddd; padding: 8px; text-align: right;} th{background-color: #f2f2f2;}</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(`<h2>لیست چاپ - ${new Date().toLocaleDateString('fa-IR')}</h2>`);
        printWindow.document.write(clonedEl.innerHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    };

    elements.printPrintingBtn.addEventListener('click', () => {
        if (currentFilteredPrintingLog.length > 0) {
            printContent(elements.printingTableContainer);
        } else {
            showToast('موردی برای چاپ وجود ندارد.', 'error');
        }
    });

    // --- Tracking View Logic ---
    const renderTrackingView = () => {
        const batchCodes = Object.keys(appState.productionBatches);
        const allGroups = new Set();
        batchCodes.forEach(code => {
            appState.productionBatches[code].logIds.forEach(id => {
                const log = appState.productionLog.find(l => l.logId === id);
                if (log) allGroups.add(log.productGroup);
            });
        });
        elements.trackingGroupFilter.innerHTML = '<option value="">همه</option>' + [...allGroups].sort().map(g => `<option>${g}</option>`).join('');
        applyTrackingFilters();
    };
    
    const applyTrackingFilters = () => {
        const search = elements.trackingSearchInput.value.toLowerCase();
        const date = elements.trackingDateFilter.value;
        const group = elements.trackingGroupFilter.value;
        const status = elements.trackingStatusFilter.value;
        currentFilteredBatches = Object.values(appState.productionBatches).filter(batch => {
            const hasGroup = group ? batch.logIds.some(id => appState.productionLog.find(l=>l.logId === id)?.productGroup === group) : true;
            const hasStatus = status ? (status === 'completed' && batch.isCompleted) || (status === 'inprogress' && !batch.isCompleted) : true;
            return batch.code.toLowerCase().includes(search) && (!date || new Date(batch.creationDate).toISOString().slice(0, 10) === date) && hasGroup && hasStatus;
        }).sort((a, b) => new Date(b.creationDate) - new Date(a.creationDate));
        renderBatchTrackingTable(currentFilteredBatches);
    };
    [elements.trackingSearchInput, elements.trackingDateFilter, elements.trackingGroupFilter, elements.trackingStatusFilter].forEach(el => {
        el.addEventListener('input', applyTrackingFilters);
        el.addEventListener('change', applyTrackingFilters);
    });

    const renderBatchTrackingTable = (batches) => {
        if (batches.length === 0) {
            elements.batchTrackingTableContainer.innerHTML = '<p>هیچ بچ تولیدی با این فیلترها یافت نشد.</p>'; return;
        }
        let tableHTML = `<table><thead><tr><th>کد بچ</th><th>تاریخ ایجاد</th><th>تاریخ تحویل</th><th>تعداد کل</th><th>وضعیت</th><th>عملیات</th></tr></thead><tbody>`;
        batches.forEach(batch => {
            const totalQuantity = batch.logIds.reduce((sum, id) => sum + (appState.productionLog.find(l => l.logId === id)?.quantity || 0), 0);
            const statusBadge = batch.isCompleted ? '<span class="status-badge status-badge-completed">تکمیل شده</span>' : '<span class="status-badge status-badge-inprogress">درحال انجام</span>';
            tableHTML += `<tr><td><strong>${batch.code}</strong></td><td>${new Date(batch.creationDate).toLocaleDateString('fa-IR')}</td><td>${batch.deliveryDate}</td><td>${totalQuantity}</td><td>${statusBadge}</td><td><button class="btn-primary details-toggle-btn" data-batch-code="${batch.code}">مشاهده جزئیات</button></td></tr>`;
            tableHTML += `<tr class="details-row" id="details-${batch.code}"><td colspan="6" class="details-cell"><div class="details-content"></div></td></tr>`;
        });
        elements.batchTrackingTableContainer.innerHTML = tableHTML + '</tbody></table>';
    };

    elements.batchTrackingTableContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('details-toggle-btn')) {
            const batchCode = e.target.dataset.batchCode;
            const detailsRow = document.getElementById(`details-${batchCode}`);
            const isVisible = detailsRow.classList.toggle('visible');
            if (isVisible) {
                const batch = appState.productionBatches[batchCode];
                const contentDiv = detailsRow.querySelector('.details-content');
                let itemsList = '<h4>لیست آیتم‌ها:</h4><ul>';
                const groupedItems = batch.logIds.reduce((acc, id) => {
                    const log = appState.productionLog.find(l => l.logId === id);
                    if (log) {
                        const key = `${log.productName} - ${log.color} - ${log.size}`;
                        if (!acc[key]) acc[key] = { ...log, quantity: 0 };
                        acc[key].quantity += log.quantity;
                    }
                    return acc;
                }, {});
                Object.values(groupedItems).forEach(item => {
                    itemsList += `<li>${item.productName} (${item.color}, ${item.size}) - تعداد: ${item.quantity}</li>`;
                });
                
                let checklist = '<h4>مراحل تولید:</h4><ul class="stage-checklist">';
                Object.entries(PRODUCTION_STAGES).forEach(([key, name]) => {
                    checklist += `<li><label><input type="checkbox" class="stage-checkbox" data-batch-code="${batch.code}" data-stage="${key}" ${batch.stages[key] ? 'checked' : ''}>${name}</label></li>`;
                });
                contentDiv.innerHTML = itemsList + '</ul>' + checklist + '</ul>';
            }
        }
    });

    elements.batchTrackingTableContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('stage-checkbox')) {
            const batchCode = e.target.dataset.batchCode;
            const stage = e.target.dataset.stage;
            const isChecked = e.target.checked;
            appState.productionBatches[batchCode].stages[stage] = isChecked;
            const allStagesDone = Object.values(appState.productionBatches[batchCode].stages).every(s => s);
            appState.productionBatches[batchCode].isCompleted = allStagesDone;
            saveState();
        }
    });

    elements.exportTrackingBtn.addEventListener('click', () => {
        if (currentFilteredBatches.length === 0) { showToast('داده‌ای برای خروجی وجود ندارد.', 'error'); return; }
        const dataToExport = [];
        currentFilteredBatches.forEach(batch => {
            const totalQuantity = batch.logIds.reduce((sum, id) => sum + (appState.productionLog.find(l => l.logId === id)?.quantity || 0), 0);
            dataToExport.push({
                'کد بچ': batch.code, 'تاریخ ایجاد': new Date(batch.creationDate).toLocaleDateString('fa-IR'),
                'تاریخ تحویل': batch.deliveryDate, 'تعداد کل': totalQuantity,
                'وضعیت': batch.isCompleted ? 'تکمیل شده' : 'درحال انجام',
                ...Object.fromEntries(Object.entries(batch.stages).map(([key, val]) => [PRODUCTION_STAGES[key], val ? 'انجام' : 'انجام نشده']))
            });
        });
        exportToExcel(dataToExport, `Tracking-Report-${new Date().toLocaleDateString('fa-IR').replace(/\//g, '-')}.xlsx`);
    });

    // --- Clear Filter Buttons ---
    const clearFilters = (elementsToClear) => {
        elementsToClear.forEach(el => {
            if (el.tagName === 'SELECT') el.selectedIndex = 0;
            else el.value = '';
        });
    };
    elements.clearProcessingFiltersBtn.addEventListener('click', () => { 
        clearFilters([elements.groupFilter, elements.colorFilter, elements.sizeFilter, elements.processingStatusFilter]);
        applyProcessingFilters();
    });
    elements.clearReportFiltersBtn.addEventListener('click', () => {
        clearFilters([elements.reportFileFilter, elements.reportStatusFilter, elements.reportGroupFilter, elements.reportBatchSearch, elements.reportBatchFilter]);
        applyReportFilters();
    });
    elements.clearPrintingFiltersBtn.addEventListener('click', () => {
        clearFilters([elements.printingFileFilter, elements.printingGroupFilter, elements.printingColorFilter, elements.printingSizeFilter]);
        applyPrintingFilters();
    });
    elements.clearTrackingFiltersBtn.addEventListener('click', () => {
        clearFilters([elements.trackingSearchInput, elements.trackingDateFilter, elements.trackingGroupFilter, elements.trackingStatusFilter]);
        applyTrackingFilters();
    });
    
});
</script>

</body>
</html>
